:root {
  --background-color: #000000;
  --card-background: #1a1a1a;
  --primary-text-color: #e0e0e0;
  --secondary-text-color: #b0b0b0;
  --border-color: transparent;
  --accent-color: #fff;
  --accent-hover-color: #fff;
  --input-background: #000;
  --error-color: #800000;
  
  /* Variables for Floating Menu */
  --glass-bg: rgba(26, 26, 26, 0.8);
  --glass-border: 1px solid rgba(255, 255, 255, 0.1);
  --border-radius: 15px;
}

body {
  font-family: 'Questrial', sans-serif;
  background-color: var(--background-color);
  color: var(--primary-text-color);
  margin: 0;
  font-size: 1rem;
  line-height: 1.45;
  user-select: none;
}

h1 {
  font-size: 1.3rem;
  margin: 0;
}

h2 {
  font-size: 1.0rem;
  margin-top: 0;
  margin-bottom: 1.2rem;
}

label,
p {
  font-size: 0.8rem;
}

button,
select {
  font-family: 'Questrial', sans-serif;
  font-size: 0.8rem;
}

input {
  font-family: 'Monaspace Neon', sans-serif;
  font-size: 0.8rem;
}

.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 1.5rem;
}

.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0;
  margin-bottom: 1.3rem;
}

.header a {
  text-decoration: none;
  color: var(--primary-text-color);
  -webkit-tap-highlight-color: transparent; 
}

.header a img {
  height: auto; 
  max-width: 155px;
  pointer-events: none;
  user-select: none;
  -webkit-user-select: none;
  -ms-user-select: none;
}

.menu-button {
  background: none;
  border: none;
  color: var(--primary-text-color);
  cursor: pointer;
  padding: 8px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 40px;
  height: 40px;
  z-index: 1002; /* Ensure button is above other content */
}

.grid-container {
  display: grid;
  grid-template-columns: 1fr;
  gap: 1.5rem;
}

@media (min-width: 992px) {
  .grid-container {
    grid-template-columns: 400px 1fr;
  }
  .card {
    grid-column: 1;
    grid-row: 1;
  }
  .player-wrapper {
    grid-column: 2;
    grid-row: 1;
  }
}

.card {
  background-color: var(--card-background);
  border-radius: 15px;
  padding: 1.5rem;
}

.input-group {
  margin-bottom: 1.2rem;
}

.input-group label {
  display: block;
  margin-bottom: 0.5rem;
  color: var(--secondary-text-color);
  font-weight: 500;
}

input[type="text"],
select {
  width: 100%;
  padding: 0.7rem;
  border: transparent;
  border-radius: 8px;
  background-color: var(--input-background);
  color: var(--primary-text-color);
  box-sizing: border-box;
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
  padding-right: 36px !important;
}

.select-wrapper {
  position: relative;
  width: 100%;
}

.select-wrapper::after {
  content: 'expand_more';
  font-family: 'Material Symbols Rounded';
  font-weight: 200;
  font-size: 24px;
  color: var(--secondary-text-color);
  position: absolute;
  top: 50%;
  right: 10px;
  transform: translateY(-50%);
  pointer-events: none;
}

input[type="text"]::placeholder {
  color: #777;
  border: transparent;
}

button {
  display: block;
  width: 100%;
  padding: 0.8rem;
  border: none;
  border-radius: 50px;
  background-color: var(--accent-color);
  color: #000;
  font-weight: 600;
  cursor: pointer;
  outline: none;
  -webkit-tap-highlight-color: transparent;
}

.input-mode-switcher {
  display: flex;
  background-color: var(--input-background);
  border-radius: 50px;
  padding: 5px;
  margin-bottom: 1.5rem;
  position: relative;
}

.input-mode-switcher button {
  flex: 1;
  padding: 0.5rem;
  background: none;
  color: var(--secondary-text-color);
  font-weight: 600;
  z-index: 2;
}

.input-mode-switcher button.active {
  color: #000;
}

.input-mode-switcher::before {
  content: '';
  position: absolute;
  top: 5px;
  font-weight: 600;
  left: var(--slider-left, 5px);
  width: var(--slider-width, 50%);
  height: calc(100% - 10px);
  background-color: var(--accent-color);
  border-radius: 50px;
  transition: left 0.25s ease, width 0.25s ease;
  z-index: 1;
  -webkit-tap-highlight-color: transparent;
}

.m3u-input-container {
  display: flex;
  align-items: center;
}

#upload-m3u-button {
  width: 44px;
  height: 44px;
  border-radius: 50%;
  padding: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  margin-right: 0.7rem;
  background-color: #fff;
  color: #000;
   -webkit-tap-highlight-color: transparent;
}

.player-wrapper {
  background-color: #000;
  border-radius: 15px;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

#video-container {
  width: 100%;
  flex-grow: 1;
  min-height: 200px;
}

#video {
  width: 100%;
  height: 100%;
}

#channel-name-display {
  padding: 0.8rem 1.2rem;
  background-color: var(--card-background);
  margin: 0;
  font-weight: 600;
  text-align: left;
  font-size: 0.85rem;
}

/* Floating Menu Styles */
.floating-menu {
    position: fixed;
    top: 65px;
    right: 24px;
    background: var(--glass-bg);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: var(--glass-border);
    border-radius: var(--border-radius);
    z-index: 1001;
    padding: 10px;
    opacity: 0;
    transform: translateY(-10px);
    visibility: hidden;
    transition: opacity 0.3s ease, transform 0.3s ease, visibility 0.3s ease;
    width: 220px;
}

.floating-menu.active {
    opacity: 1;
    transform: translateY(0);
    visibility: visible;
}

.floating-menu ul {
    list-style: none;
    margin: 0;
    padding: 0;
}

.floating-menu li a {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 12px;
    font-weight: 500;
    font-size: 0.85rem;
    border-radius: 10px;
    cursor: pointer;
    color: var(--primary-text-color);
    text-decoration: none;
    transition: background-color 0.2s ease;
}

.floating-menu li a:hover {
    background-color: rgba(255, 255, 255, 0.1);
}

.floating-menu li a .material-symbols-rounded {
    font-size: 1.4rem;
    color: var(--secondary-text-color);
}

.site-footer {
  text-align: center;
  bottom: 1rem;
  padding: 1rem;
  color: var(--primary-text-color);
}

.site-footer p {
  margin: 0;
  font-size: 0.6rem;
}

hr {
  border: none;
  border-top: 1px solid rgba(201, 201, 201, 0.25);
  margin: 1.5rem 0;
}

#error-display {
  display: none;
  margin-top: 1rem;
  padding: 0.8rem;
  border-radius: 8px;
  background-color: var(--error-color);
  color: #fff;
  font-size: 0.85rem;
}


let player;
let ui;
let playlistData = [];
let defaultStreamsData = {}; 

const video = document.getElementById('video');
const videoContainer = document.getElementById('video-container');
const errorDisplay = document.getElementById('error-display');
const manifestUriInput = document.getElementById('manifestUri');
const licenseServerUrlInput = document.getElementById('licenseServerUrl');
const licenseTypeSelect = document.getElementById('licenseTypeSelect');
const k1Input = document.getElementById('k1');
const k2Input = document.getElementById('k2');
const drmFieldsContainer = document.querySelector('.drm-fields');
const licenseUrlContainer = document.getElementById('license-url-container');
const clearkeyContainer = document.getElementById('clearkey-container');
const channelSelector = document.getElementById('channelSelector');
const channelNameDisplay = document.getElementById('channel-name-display');
const m3uLinkInput = document.getElementById('m3uLink');
const m3uFileInput = document.getElementById('m3uFile');
const uploadM3uButton = document.getElementById('upload-m3u-button');
const loadPlaylistButton = document.getElementById('loadPlaylistButton');
const loadManualButton = document.getElementById('loadButton');
const inputModeSwitcher = document.querySelector('.input-mode-switcher');
const addModeBtn = document.getElementById('add-mode-btn');
const manualModeBtn = document.getElementById('manual-mode-btn');
const addModeContainer = document.getElementById('add-mode-container');
const manualModeContainer = document.getElementById('manual-mode-container');
const sourceSelector = document.getElementById('sourceSelector');
const playlistInputs = document.getElementById('playlist-inputs');

// Menu Elements
const menuToggleBtn = document.getElementById('menu-toggle-btn');
const floatingMenu = document.getElementById('floating-menu');

function toggleDrmBlockVisibility() {
  const manifestUri = manifestUriInput.value.toLowerCase().trim();
  const isMpd = manifestUri.includes('.mpd');
  
  if (drmFieldsContainer) {
    drmFieldsContainer.style.display = isMpd ? 'block' : 'none';
  }
}

function updateDrmFieldVisibility() {
    const selectedType = licenseTypeSelect.value;
    const isWidevine = selectedType === 'com.widevine.alpha';
    const isNone = selectedType === 'none';

    if (licenseUrlContainer && clearkeyContainer) {
        licenseUrlContainer.style.display = isWidevine ? 'block' : 'none';
        clearkeyContainer.style.display = !isWidevine && !isNone ? 'block' : 'none';
    }
}

function handleRouting() {
  const redirectPath = sessionStorage.getItem('redirectPath');
  if (redirectPath) sessionStorage.removeItem('redirectPath');
  const currentPath = redirectPath || window.location.pathname;
  const pathSegments = currentPath.split('/').filter(Boolean);
  const isGitHubPages = window.location.hostname.includes('github.io');
  const effectivePath = isGitHubPages && pathSegments.length > 1 
    ? `/${pathSegments[pathSegments.length - 1]}` 
    : currentPath;

  if (effectivePath.toLowerCase().startsWith('/manual')) {
    switchInputMode('manual', false);
  } else {
    switchInputMode('playlist', false);
  }
}

function switchInputMode(mode, pushState = true) {
  const isPlaylist = mode === 'playlist';
  addModeContainer.style.display = isPlaylist ? 'block' : 'none';
  manualModeContainer.style.display = isPlaylist ? 'none' : 'block';
  addModeBtn.classList.toggle('active', isPlaylist);
  manualModeBtn.classList.toggle('active', !isPlaylist);
  updateSliderPosition();

  if (pushState) {
    const newRoute = isPlaylist ? 'playlist' : 'manual';
    const isGitHubPages = window.location.hostname.includes('github.io');
    const repoName = isGitHubPages ? `/${window.location.pathname.split('/')[1]}` : '';
    const finalPath = `${repoName}/${newRoute}`;
    if (window.location.pathname !== finalPath) {
      history.pushState({ mode: mode }, '', finalPath);
    }
  }
}

function initPlayer() {
  shaka.polyfill.installAll();
  if (shaka.Player.isBrowserSupported()) {
    player = new shaka.Player(video);
    ui = new shaka.ui.Overlay(player, videoContainer, video);
    player.addEventListener('error', onError);
  } else {
    showError('Your browser does not support Shaka Player.');
  }
}

async function loadStream(name) {
  const manifestUri = manifestUriInput.value.trim();
  const displayName = name || 'Manual Input';

  errorDisplay.style.display = 'none';
  if (!manifestUri) return alert('Manifest URI is required.');
  
  channelNameDisplay.textContent = `Loading: ${displayName}...`;

  const config = { drm: {} };
  const selectedDrmType = licenseTypeSelect.value;

  if (drmFieldsContainer.style.display === 'block' && selectedDrmType !== 'none') {
    if (selectedDrmType === 'com.widevine.alpha') {
      const licenseServerUrl = licenseServerUrlInput.value.trim();
      if (licenseServerUrl) {
        config.drm.servers = { [selectedDrmType]: licenseServerUrl };
      }
    } else if (selectedDrmType === 'org.w3.clearkey') {
      const kid = k1Input.value.trim();
      const key = k2Input.value.trim();
      if (kid && key) {
        config.drm.clearKeys = { [kid]: key };
      }
    }
  }
  
  player.configure(config);

  try {
    await player.load(manifestUri);
    channelNameDisplay.textContent = displayName;
  } catch (e) {
    onError({ detail: e });
    channelNameDisplay.textContent = `Failed to load: ${displayName}`;
  }
}

async function fetchDefaultStreams() {
    try {
        const response = await fetch('js/getChannels.js');
        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
        defaultStreamsData = await response.json();
        if (sourceSelector && sourceSelector.value === 'default') {
            populateDefaultChannels();
        }
    } catch (e) {
        showError(`Failed to load default streams: ${e.message}`);
    }
}

async function handlePlaylistLoad() {
  let m3uData = '';
  errorDisplay.style.display = 'none';
  const file = m3uFileInput.files[0];
  const link = m3uLinkInput.value.trim();

  try {
    if (link) {
      const response = await fetch(link);
      if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
      m3uData = await response.text();
    } else if (file) {
      m3uData = await file.text();
    } else {
      return alert('Please enter an M3U link or upload a file first.');
    }
    playlistData = parseM3U(m3uData);
    populatePlaylistChannels();
  } catch (e) {
    showError(`Failed to load playlist: ${e.message}`);
  }
}

function base64UrlToHex(base64Url) {
  try {
    let base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    while (base64.length % 4) {
      base64 += '=';
    }
    const raw = atob(base64);
    let hex = '';
    for (let i = 0; i < raw.length; i++) {
      hex += raw.charCodeAt(i).toString(16).padStart(2, '0');
    }
    return hex;
  } catch (e) {
    console.error('Failed to decode base64 string:', base64Url, e);
    return null;
  }
}

function parseM3U(data) {
  const lines = data.split('\n');
  const channels = [];
  let currentChannel = {};
  for (const line of lines) {
    const trimmedLine = line.trim();
    if (trimmedLine.startsWith('#EXTINF:')) {
      const info = trimmedLine.split(/,(.*)/s);
      currentChannel.name = info[1]?.trim() || 'Unknown Channel';
    } else if (trimmedLine.startsWith('#KODIPROP:inputstream.adaptive.license_type=')) {
      const type = trimmedLine.split('=')[1]?.trim();
      if (type.toLowerCase() === 'clearkey') {
        currentChannel.licenseType = 'org.w3.clearkey';
      } else {
        currentChannel.licenseType = type;
      }
    } else if (trimmedLine.startsWith('#KODIPROP:inputstream.adaptive.license_key=')) {
      const keyData = trimmedLine.split('=').slice(1).join('=');
      
      if (keyData.trim().startsWith('{')) {
        try {
          const parsedJson = JSON.parse(keyData);
          if (parsedJson.keys && parsedJson.keys.length > 0) {
            const keyInfo = parsedJson.keys[0];
            if (keyInfo.k && keyInfo.kid) {
              currentChannel.k2 = base64UrlToHex(keyInfo.k);
              currentChannel.k1 = base64UrlToHex(keyInfo.kid);
              currentChannel.licenseType = 'org.w3.clearkey';
            }
          }
        } catch (e) {
          console.error('Failed to parse license_key JSON:', keyData, e);
        }
      }
      else if (keyData.includes('http://') || keyData.includes('https://')) {
        currentChannel.licenseKey = keyData.trim();
      } 
      else {
        const keyParts = keyData.split(':');
        if (keyParts.length === 2 && keyParts[0].trim() && keyParts[1].trim()) {
          currentChannel.k1 = keyParts[0].trim();
          currentChannel.k2 = keyParts[1].trim();
        }
      }
    } else if (trimmedLine && !trimmedLine.startsWith('#')) {
      currentChannel.url = trimmedLine;
      channels.push(currentChannel);
      currentChannel = {};
    }
  }
  return channels;
}

function populatePlaylistChannels() {
  channelSelector.innerHTML = '<option value="">-- Select a channel --</option>';
  if (playlistData.length > 0) {
    playlistData.forEach((channel, index) => {
      const option = new Option(channel.name, `playlist_${index}`);
      channelSelector.appendChild(option);
    });
    alert(`${playlistData.length} channels loaded. Please select one.`);
  } else {
    alert('No channels found or playlist is empty.');
  }
  
  m3uFileInput.value = '';
}

function populateDefaultChannels() {
    channelSelector.innerHTML = '<option value="">-- Select a Sample Stream --</option>';
    Object.keys(defaultStreamsData).forEach(channelKey => {
        const displayName = channelKey.replace(/_/g, ' '); 
        const option = new Option(displayName, `default_${channelKey}`);
        channelSelector.appendChild(option);
    });
}

function onChannelSelect(event) {
  const selectedValue = event.target.value;
  if (!selectedValue) return;

  let channel;
  let displayName;

  if (selectedValue.startsWith('playlist_')) {
      const m3uIndex = parseInt(selectedValue.substring(9), 10);
      channel = playlistData[m3uIndex];
      displayName = channel.name;
  } else if (selectedValue.startsWith('default_')) {
      const streamKey = selectedValue.substring(8);
      channel = defaultStreamsData[streamKey];
      displayName = streamKey.replace(/_/g, ' ');
  }

  if (channel) {
    manifestUriInput.value = channel.url || '';
    
    if ((channel.licenseType === 'org.w3.clearkey' || (channel.k1 && channel.k2)) && channel.k1 && channel.k2) {
        licenseTypeSelect.value = 'org.w3.clearkey';
        k1Input.value = channel.k1;
        k2Input.value = channel.k2;
        licenseServerUrlInput.value = '';
    } else if (channel.licenseType && channel.licenseKey) {
        licenseTypeSelect.value = channel.licenseType;
        licenseServerUrlInput.value = channel.licenseKey;
        k1Input.value = '';
        k2Input.value = '';
    } else {
        licenseTypeSelect.value = 'none'; // Default to 'none'
        licenseServerUrlInput.value = '';
        k1Input.value = '';
        k2Input.value = '';
    }
    
    toggleDrmBlockVisibility();
    updateDrmFieldVisibility(); 
    loadStream(displayName);
  }
}

function handleSourceChange(event) {
    const selectedSource = event.target.value;
    channelSelector.innerHTML = '<option value="">-- Select a source first --</option>';
    if (selectedSource === 'default') {
        playlistInputs.style.display = 'none'; 
        populateDefaultChannels();
    } else { 
        playlistInputs.style.display = 'block';
        if (playlistData.length > 0) populatePlaylistChannels();
    }
}

function updateSliderPosition() {
  const activeButton = inputModeSwitcher.querySelector('button.active');
  if (activeButton) {
    inputModeSwitcher.style.setProperty('--slider-left', `${activeButton.offsetLeft}px`);
    inputModeSwitcher.style.setProperty('--slider-width', `${activeButton.offsetWidth}px`);
  }
}

function showError(message) {
  console.error(message);
  errorDisplay.textContent = message;
  errorDisplay.style.display = 'block';
}

function onError(event) {
  const error = event.detail;
  console.error('Shaka Player Error:', error);
  showError(`Error Code: ${error.code}\nCategory: ${error.category}`);
}

function toggleMenu() {
    if (floatingMenu) {
        floatingMenu.classList.toggle('active');
    }
}

function setupEventListeners() {
  uploadM3uButton.addEventListener('click', () => m3uFileInput.click());
  loadPlaylistButton.addEventListener('click', handlePlaylistLoad);
  loadManualButton.addEventListener('click', () => loadStream());
  channelSelector.addEventListener('change', onChannelSelect);
  addModeBtn.addEventListener('click', () => switchInputMode('playlist'));
  manualModeBtn.addEventListener('click', () => switchInputMode('manual'));
  window.addEventListener('resize', updateSliderPosition);
  window.addEventListener('popstate', handleRouting);
  manifestUriInput.addEventListener('input', toggleDrmBlockVisibility);
  licenseTypeSelect.addEventListener('change', updateDrmFieldVisibility);
  m3uFileInput.addEventListener('change', handlePlaylistLoad);
  
  if (sourceSelector) {
    sourceSelector.addEventListener('change', handleSourceChange);
  }

  // Menu event listeners
  if (menuToggleBtn && floatingMenu) {
      menuToggleBtn.addEventListener('click', (event) => {
          event.stopPropagation(); // Prevent this click from being caught by the window listener
          toggleMenu();
      });

      // Close the menu if clicked outside
      window.addEventListener('click', (event) => {
          if (floatingMenu.classList.contains('active') && !floatingMenu.contains(event.target)) {
              toggleMenu();
          }
      });
  }
}

function main() {
  setupEventListeners();
  handleRouting(); 
  initPlayer();
  fetchDefaultStreams(); 
  toggleDrmBlockVisibility(); 
  updateDrmFieldVisibility();
}

document.addEventListener('DOMContentLoaded', main);```
